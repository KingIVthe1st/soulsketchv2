<!DOCTYPE html>
<html lang="zxx">
  <head>
    <!-- Meta -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1"
    />
    <meta
      name="description"
      content="Start your sketch with our 7‑step frontend demo. Save progress locally and see a sample upon completion."
    />
    <meta name="keywords" content="" />
    <meta name="author" content="RW2DESIGN PRIVATE LIMITED" />
    <!-- Page Title -->
    <title>Start Your Sketch — Sketch My Soulmate (Demo)</title>
    <!-- Favicon Icon -->
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.png" />
    <!-- Google Fonts Css-->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@300..800&family=Manrope:wght@200..800&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap Css -->
    <link href="css/bootstrap.min.css" rel="stylesheet" media="screen" />
    <!-- SlickNav Css -->
    <link href="css/slicknav.min.css" rel="stylesheet" />
    <!-- Swiper Css -->
    <link rel="stylesheet" href="css/swiper-bundle.min.css" />
    <!-- Font Awesome Icon Css-->
    <link href="css/all.min.css" rel="stylesheet" media="screen" />
    <!-- Animated Css -->
    <link href="css/animate.css" rel="stylesheet" />
    <!-- Magnific Popup Core Css File -->
    <link rel="stylesheet" href="css/magnific-popup.css" />
    <!-- Mouse Cursor Css File -->
    <link rel="stylesheet" href="css/mousecursor.css" />
    <!-- Main Custom Css -->
    <link href="css/custom.css" rel="stylesheet" media="screen" />
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <!-- Custom Apple Pay Button Styles -->
    <style>
      .apple-pay-button {
        position: relative;
        overflow: hidden;
      }
      
      .apple-pay-button:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }
      
      .apple-pay-button:hover {
        background-color: #333 !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      
      .apple-pay-button img {
        transition: transform 0.2s ease;
      }
      
      .apple-pay-button:hover img {
        transform: scale(1.05);
      }
      
      /* Ripple effect for Apple Pay button */
      .apple-pay-button::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
        transition: width 0.6s, height 0.6s, top 0.6s, left 0.6s;
        transform: translate(-50%, -50%);
        z-index: 0;
      }
      
      .apple-pay-button:active::before {
        width: 300px;
        height: 300px;
      }
      
      .apple-pay-button * {
        position: relative;
        z-index: 1;
      }
    </style>
  </head>
  <body>
    <!-- Preloader Start -->
    <div class="preloader">
      <div class="loading-container">
        <div class="loading"></div>
        <div id="loading-icon"><img src="images/loader.svg" alt="" /></div>
      </div>
    </div>
    <!-- Preloader End -->

    <!-- Generating Report Screen Start -->
    <div id="generatingReportScreen" class="generating-overlay" style="display: none; opacity: 0;">
      <div class="generating-content">
        <div class="mystical-orb">
          <div class="orb-core"></div>
          <div class="orb-ring ring-1"></div>
          <div class="orb-ring ring-2"></div>
          <div class="orb-ring ring-3"></div>
        </div>
        <div class="generating-text">
          <h2>Channeling Your Soulmate's Energy</h2>
          <p id="generatingStatus">Connecting with the cosmic forces...</p>
        </div>
        <div class="mystical-particles">
          <div class="particle particle-1"></div>
          <div class="particle particle-2"></div>
          <div class="particle particle-3"></div>
          <div class="particle particle-4"></div>
          <div class="particle particle-5"></div>
          <div class="particle particle-6"></div>
        </div>
      </div>
    </div>
    <!-- Generating Report Screen End -->

    <!-- Header Start -->
    <header class="main-header bg-section">
      <div class="header-sticky">
        <nav class="navbar navbar-expand-lg">
          <div class="container-fluid">
            <!-- Logo Start -->
            <a class="navbar-brand" href="index.html">
              <img
                src="images/logo.svg"
                alt="Sketch My Soulmate Logo"
                style="width: 100px; height: 50px"
              />
            </a>
            <!-- Logo End -->

            <div>
              <a href="order.html" class="btn-default">Home</a>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <!-- Header End -->

    <!-- Order Wizard Start -->
    <div class="contact-map-form" style="padding: 40px 0px">
      <div class="container">
        <div class="row section-row">
          <div class="col-lg-10 offset-lg-1">
            <div class="order-progress wow fadeInUp" data-wow-delay="0.1s">
              <div id="stepLabel">Step 1 of 4 — About you</div>
              <div
                class="progress"
                role="progressbar"
                aria-valuemin="1"
                aria-valuemax="4"
                aria-valuenow="1"
              >
                <div
                  id="progressBar"
                  class="progress-bar"
                  style="width: 25%"
                ></div>
              </div>
            </div>

            <form id="orderForm" novalidate>
              <!-- Step 1: About You -->
              <section
                id="step1"
                class="order-step"
                aria-labelledby="step1_title"
              >
                <div class="section-title section-title-center">
                  <h3 class="wow fadeInUp">Step 1</h3>
                  <h2
                    id="step1_title"
                    class="wow fadeInUp"
                    data-wow-delay="0.1s"
                    data-cursor="-opaque"
                    style="margin: 40px 0px"
                  >
                    About <span>you</span>
                  </h2>
                </div>
                <div class="contact-us-form">
                  <div class="row">
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="firstName"
                        >First name or nickname</label
                      >
                      <input type="text" class="form-control" id="firstName" />
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="email"
                        >Email <span aria-hidden="true">*</span></label
                      >
                      <input
                        type="email"
                        class="form-control"
                        id="email"
                        required
                      />
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="pronouns">Pronouns</label>
                      <select id="pronouns" class="form-control">
                        <option value="">Select</option>
                        <option value="she/her">She/Her</option>
                        <option value="he/him">He/Him</option>
                        <option value="they/them">They/Them</option>
                        <option value="self-describe">Self-Describe</option>
                        <option value="prefer-not">Prefer Not to Say</option>
                      </select>
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="country">Country</label>
                      <input type="text" class="form-control" id="country" />
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="timezone">Timezone</label>
                      <input
                        type="text"
                        class="form-control"
                        id="timezone"
                        aria-describedby="tz_help"
                      />
                      <small id="tz_help" class="text-muted"
                        >Auto-detected; you can edit.</small
                      >
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="attractedTo"
                        >Who are you attracted to?</label
                      >
                      <select id="attractedTo" class="form-control">
                        <option value="all-genders">All Genders</option>
                        <option value="women">Women</option>
                        <option value="men">Men</option>
                        <option value="non-binary">Non-Binary</option>
                      </select>
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="ageRange"
                        >Your age range</label
                      >
                      <select id="ageRange" class="form-control">
                        <option value="">Select</option>
                        <option value="18-24">18–24</option>
                        <option value="25-34">25–34</option>
                        <option value="35-44">35–44</option>
                        <option value="45-54">45–54</option>
                        <option value="55+">55+</option>
                      </select>
                    </div>
                  </div>
                  <small class="text-muted d-block mt-2"
                    >Why we ask: Helps tailor facial cues and presentation;
                    email is needed for delivery.</small
                  >
                </div>
                <div class="what-we-btn order-nav" style="margin: 40px 0px">
                  <div>
                    <button type="button" class="btn-default next">Next</button>
                  </div>
                </div>
              </section>

              <!-- Step 2: Birth & Spiritual Insights -->
              <section
                id="step2"
                class="order-step"
                aria-labelledby="step2_title"
                style="display: none"
              >
                <div class="section-title section-title-center">
                  <h3>Step 2</h3>
                  <h2
                    id="step2_title"
                    data-cursor="-opaque"
                    style="margin: 40px 0px"
                  >
                    Birth & <span>Spiritual</span> Insights
                  </h2>
                </div>
                <div class="contact-us-form">
                  <div class="row">
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="birthDate"
                        >Date of birth</label
                      >
                      <input type="date" class="form-control" id="birthDate" />
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="birthTime"
                        >Time of birth</label
                      >
                      <input type="time" class="form-control" id="birthTime" />
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="birthCity"
                        >Birth city</label
                      >
                      <input type="text" class="form-control" id="birthCity" />
                    </div>
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="zodiac"
                        >Derived zodiac</label
                      >
                      <input
                        type="text"
                        class="form-control"
                        id="zodiac"
                        readonly
                      />
                    </div>
                  </div>
                  <div
                    class="form-group col-md-6 mb-4 d-flex align-items-center"
                  >
                    <div class="form-check">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="includeReading"
                      />
                      <label class="form-check-label" for="includeReading"
                        >Include spiritual reading</label
                      >
                    </div>
                  </div>
                  <small class="text-muted d-block mt-2"
                    >Why we ask: Inspires the energy palette and optional
                    reading.</small
                  >
                </div>
                <div class="what-we-btn order-nav" style="margin: 40px 0px">
                  <button type="button" class="btn-default back">Back</button>
                  <button type="button" class="btn-default skip">Skip</button>
                  <button type="button" class="btn-default next">Next</button>
                </div>
              </section>

              

              <!-- Step 4: Personality & Lifestyle -->
              <section
                id="step4"
                class="order-step"
                aria-labelledby="step4_title"
                style="display: none"
              >
                <div class="section-title section-title-center">
                  <h3>Step 3</h3>
                  <h2
                    id="step4_title"
                    data-cursor="-opaque"
                    style="margin: 40px 0px"
                  >
                    Personality & <span>Lifestyle</span>
                  </h2>
                </div>
                <div class="contact-us-form">
                  <div class="row">
                    <div class="form-group col-md-4 mb-4">
                      <label class="form-label" for="slider_introvert"
                        >Introverted ↔ Extroverted</label
                      >
                      <input
                        id="slider_introvert"
                        type="range"
                        min="0"
                        max="100"
                        step="1"
                        class="form-range"
                      />
                    </div>
                    <div class="form-group col-md-4 mb-4">
                      <label class="form-label" for="slider_grounded"
                        >Grounded ↔ Adventurous</label
                      >
                      <input
                        id="slider_grounded"
                        type="range"
                        min="0"
                        max="100"
                        step="1"
                        class="form-range"
                      />
                    </div>
                    <div class="form-group col-md-4 mb-4">
                      <label class="form-label" for="slider_analytical"
                        >Analytical ↔ Creative</label
                      >
                      <input
                        id="slider_analytical"
                        type="range"
                        min="0"
                        max="100"
                        step="1"
                        class="form-range"
                      />
                    </div>
                    <div class="form-group col-md-12 mb-4">
                      <label class="form-label">Love languages</label>
                      <div class="row">
                        <div class="col-md-4">
                          <label for="ll_words" class="form-label">Words</label
                          ><input
                            id="ll_words"
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            class="form-range"
                          />
                        </div>
                        <div class="col-md-4">
                          <label for="ll_qualityTime" class="form-label"
                            >Quality time</label
                          ><input
                            id="ll_qualityTime"
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            class="form-range"
                          />
                        </div>
                        <div class="col-md-4">
                          <label for="ll_gifts" class="form-label">Gifts</label
                          ><input
                            id="ll_gifts"
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            class="form-range"
                          />
                        </div>
                        <div class="col-md-4">
                          <label for="ll_acts" class="form-label">Acts</label
                          ><input
                            id="ll_acts"
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            class="form-range"
                          />
                        </div>
                        <div class="col-md-4">
                          <label for="ll_touch" class="form-label">Touch</label
                          ><input
                            id="ll_touch"
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            class="form-range"
                          />
                        </div>
                      </div>
                    </div>

                    <div class="form-group col-md-12 mb-4">
                      <label class="form-label">Values (choose any)</label>
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="family"
                              id="val_family"
                            /><label class="form-check-label" for="val_family"
                              >Family</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="growth"
                              id="val_growth"
                            /><label class="form-check-label" for="val_growth"
                              >Growth</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="stability"
                              id="val_stability"
                            /><label
                              class="form-check-label"
                              for="val_stability"
                              >Stability</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="kindness"
                              id="val_kindness"
                            /><label class="form-check-label" for="val_kindness"
                              >Kindness</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="spirituality"
                              id="val_spirituality"
                            /><label
                              class="form-check-label"
                              for="val_spirituality"
                              >Spirituality</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="ambition"
                              id="val_ambition"
                            /><label class="form-check-label" for="val_ambition"
                              >Ambition</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="humor"
                              id="val_humor"
                            /><label class="form-check-label" for="val_humor"
                              >Humor</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="health"
                              id="val_health"
                            /><label class="form-check-label" for="val_health"
                              >Health</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="curiosity"
                              id="val_curiosity"
                            /><label
                              class="form-check-label"
                              for="val_curiosity"
                              >Curiosity</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="service"
                              id="val_service"
                            /><label class="form-check-label" for="val_service"
                              >Service</label
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <small class="text-muted d-block mt-2"
                    >Why we ask: Shapes expression/vibe and line style
                    choices.</small
                  >
                </div>
                <div class="what-we-btn order-nav" style="margin: 40px 0px">
                  <button type="button" class="btn-default back">Back</button>
                  <button type="button" class="btn-default skip">Skip</button>
                  <button type="button" class="btn-default next">Next</button>
                </div>
              </section>

              <!-- Step 4: Relationship Goals & Boundaries -->
              <section
                id="step4b"
                class="order-step"
                aria-labelledby="step4b_title"
                style="display: none"
              >
                <div class="section-title section-title-center">
                  <h3>Step 4</h3>
                  <h2
                    id="step4b_title"
                    data-cursor="-opaque"
                    style="margin: 40px 0px"
                  >
                    Relationship <span>Goals</span> & Boundaries
                  </h2>
                </div>
                <div class="contact-us-form">
                  <div class="row">
                    <div class="form-group col-md-6 mb-4">
                      <label class="form-label" for="lookingFor"
                        >Looking for</label
                      >
                      <select id="lookingFor" class="form-control">
                        <option value="serious">Serious relationship</option>
                        <option value="companionship">Companionship</option>
                        <option value="marriage-minded">Marriage‑minded</option>
                        <option value="exploring">Still exploring</option>
                      </select>
                    </div>
                    <div class="form-group col-md-12 mb-4">
                      <label class="form-label">Must‑haves</label>
                      <div class="row">
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="wants-kids"
                              id="mh_kids"
                            /><label class="form-check-label" for="mh_kids"
                              >Wants Kids</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="pet-friendly"
                              id="mh_pet"
                            /><label class="form-check-label" for="mh_pet"
                              >Pet‑Friendly</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="non-smoker"
                              id="mh_smoke"
                            /><label class="form-check-label" for="mh_smoke"
                              >Non‑Smoker</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="active-lifestyle"
                              id="mh_active"
                            /><label class="form-check-label" for="mh_active"
                              >Active Lifestyle</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="spiritual-openness"
                              id="mh_spirit"
                            /><label class="form-check-label" for="mh_spirit"
                              >Spiritual Openness</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="career-driven"
                              id="mh_career"
                            /><label class="form-check-label" for="mh_career"
                              >Career‑Driven</label
                            >
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-check">
                            <input
                              class="form-check-input"
                              type="checkbox"
                              value="family-oriented"
                              id="mh_family"
                            /><label class="form-check-label" for="mh_family"
                              >Family‑Oriented</label
                            >
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="form-group col-md-12 mb-4">
                      <label class="form-label" for="dealBreakers"
                        >Deal‑breakers (optional)</label
                      >
                      <textarea
                        id="dealBreakers"
                        rows="3"
                        class="form-control"
                      ></textarea>
                    </div>
                  </div>
                  <small class="text-muted d-block mt-2"
                    >Why we ask: Calibrates intent and maturity cues in
                    depiction and reading.</small
                  >
                </div>
                <div class="what-we-btn order-nav" style="margin: 40px 0px">
                  <button type="button" class="btn-default back">Back</button>
                  <button type="button" class="btn-default skip">Skip</button>
                  <button type="button" class="btn-default next">Next</button>
                </div>
              </section>

              <!-- Step 5: Choose Your Package -->
              <section
                id="step5"
                class="order-step"
                aria-labelledby="step5_title"
                style="display: none"
              >
                <div class="section-title section-title-center">
                  <h3>Step 5</h3>
                  <h2
                    id="step5_title"
                    data-cursor="-opaque"
                    style="margin: 40px 0px"
                  >
                    Choose Your <span>Package</span>
                  </h2>
                </div>
                <div class="contact-us-form">
                  <div class="row">
                    <div class="col-md-4 mb-4">
                      <div class="package-card" data-package="basic">
                        <h4>Basic Package</h4>
                        <p class="price">$19.99</p>
                        <ul>
                          <li>High-res soulmate sketch</li>
                          <li>Detailed compatibility reading</li>
                          <li>Numerology & astrology insights</li>
                          <li>Instant digital delivery</li>
                        </ul>
                        <button type="button" class="btn-default package-select">Select Basic</button>
                      </div>
                    </div>
                    <div class="col-md-4 mb-4">
                      <div class="package-card featured" data-package="plus">
                        <div class="badge">Most Popular</div>
                        <h4>Plus Package</h4>
                        <p class="price">$29.99</p>
                        <ul>
                          <li>Everything in Basic</li>
                          <li>Location insights (where they live)</li>
                          <li>Enhanced astrological analysis</li>
                          <li>Expanded PDF report</li>
                        </ul>
                        <button type="button" class="btn-default package-select">Select Plus</button>
                      </div>
                    </div>
                    <div class="col-md-4 mb-4">
                      <div class="package-card" data-package="premium">
                        <h4>Premium Package</h4>
                        <p class="price">$49.99</p>
                        <ul>
                          <li>Everything in Plus</li>
                          <li>Full astrological AI analysis</li>
                          <li>Personal relationship strategy guide</li>
                          <li>Complete cosmic profile</li>
                        </ul>
                        <button type="button" class="btn-default package-select">Select Premium</button>
                      </div>
                    </div>
                  </div>
                  <div id="selectedPackage" style="display: none;">
                    <h4>Selected Package: <span id="packageName"></span></h4>
                    <p>Total: <span id="packagePrice"></span></p>
                  </div>
                </div>
                <div class="what-we-btn order-nav" style="margin: 40px 0px">
                  <button type="button" class="btn-default back">Back</button>
                  <button type="submit" class="btn-default" id="proceedToCheckout">Proceed to Checkout</button>
                </div>
              </section>

              
            </form>

            <!-- Checkout Section -->
            <div
              id="checkoutSection"
              class="wow fadeInUp"
              data-wow-delay="0.1s"
              style="display: none"
            >
              <div class="section-title section-title-center">
                <h3>Checkout</h3>
                <h2 data-cursor="-opaque" style="margin: 40px 0px">
                  Complete Your <span>Order</span>
                </h2>
              </div>
              
              <div class="row">
                <div class="col-lg-8">
                  <!-- Payment Form -->
                  <div class="contact-us-form payment-form">
                    <h4 style="color: var(--primary-color); margin-bottom: 20px;">Payment Details</h4>
                    
                    <div class="secure-checkout-header" style="margin-bottom: 20px;">
                      <div style="display: flex; align-items: center; color: #00d4aa;">
                        <span style="margin-right: 8px;">🔒</span>
                        <span>Secure, fast checkout with Stripe</span>
                      </div>
                    </div>

                    <!-- Apple Pay / Google Pay Express Checkout -->
                    <div id="express-checkout-element" style="margin-bottom: 20px;">
                      <!-- Express checkout methods (Apple Pay, Google Pay, etc.) -->
                    </div>

                    <!-- Or separator -->
                    <div id="payment-separator" style="margin: 20px 0; text-align: center; color: var(--text-color); font-size: 14px; display: none;">
                      <span style="background: var(--bg-color); padding: 0 15px;">or pay with card</span>
                      <div style="height: 1px; background: var(--divider-color); margin-top: -10px; z-index: -1; position: relative;"></div>
                    </div>

                    <div id="stripe-payment-element">
                      <!-- Stripe Elements will mount here -->
                    </div>

                    <!-- Fallback payment form for demo -->
                    <div id="fallback-payment-form">
                      <div class="row">
                        <div class="form-group col-md-12 mb-3">
                          <label class="form-label">Card number</label>
                          <div style="position: relative;">
                            <input type="text" class="form-control" id="cardNumber" placeholder="1234 1234 1234 1234" maxlength="19">
                            <div style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: flex; gap: 5px;">
                              <img src="/logos/visa.png" alt="Visa" style="height: 16px; object-fit: contain;">
                              <img src="/logos/mastercard.png" alt="Mastercard" style="height: 16px; object-fit: contain;">
                              <img src="/logos/amex.png" alt="American Express" style="height: 16px; object-fit: contain;">
                            </div>
                          </div>
                        </div>
                        <div class="form-group col-md-6 mb-3">
                          <label class="form-label">Expiration date</label>
                          <input type="text" class="form-control" id="expDate" placeholder="MM / YY" maxlength="7">
                        </div>
                        <div class="form-group col-md-6 mb-3">
                          <label class="form-label">Security code</label>
                          <input type="text" class="form-control" id="securityCode" placeholder="CVC" maxlength="4">
                        </div>
                        <div class="form-group col-md-6 mb-3">
                          <label class="form-label">Country</label>
                          <select class="form-control" id="country">
                            <option value="US">United States</option>
                            <option value="CA">Canada</option>
                            <option value="UK">United Kingdom</option>
                            <option value="AU">Australia</option>
                          </select>
                        </div>
                        <div class="form-group col-md-6 mb-3">
                          <label class="form-label">ZIP code</label>
                          <input type="text" class="form-control" id="zipCode" placeholder="12345">
                        </div>
                      </div>

                      <!-- Apple Pay Button -->
                      <div id="applePayContainer" style="margin: 20px 0;">
                        <button id="applePayButton" class="apple-pay-button" style="
                          width: 100%;
                          height: 48px;
                          background: #000;
                          border: none;
                          border-radius: 6px;
                          color: white;
                          font-size: 16px;
                          font-weight: 500;
                          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                          cursor: pointer;
                          display: none;
                          align-items: center;
                          justify-content: center;
                          gap: 8px;
                          transition: all 0.2s ease;
                          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                        " onmouseover="this.style.backgroundColor='#333'" onmouseout="this.style.backgroundColor='#000'">
                          <img src="/images/apple-logo.png" alt="Apple" style="
                            width: 20px;
                            height: 20px;
                            filter: invert(1);
                            margin-right: 4px;
                          ">
                          Pay
                        </button>
                      </div>

                      <div style="margin: 20px 0; text-align: center; color: var(--text-color); font-size: 14px;">
                        <span style="background: var(--bg-color); padding: 0 15px;">or pay with card</span>
                        <div style="height: 1px; background: var(--divider-color); margin-top: -10px; z-index: -1; position: relative;"></div>
                      </div>

                      <div style="margin: 20px 0; padding: 15px; background: rgba(169, 62, 23, 0.1); border-radius: 8px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                          <span style="margin-right: 8px;">🍎</span>
                          <span style="color: var(--primary-color);">Apple Pay supported</span>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                          <img src="/logos/visa.png" alt="Visa" style="height: 20px; object-fit: contain;">
                          <img src="/logos/mastercard.png" alt="Mastercard" style="height: 20px; object-fit: contain;">
                          <img src="/logos/amex.png" alt="American Express" style="height: 20px; object-fit: contain;">
                        </div>
                        <div style="display: flex; align-items: center; margin-top: 10px; color: #00d4aa;">
                          <span style="margin-right: 5px;">✓</span>
                          <span style="font-size: 14px;">Secure SSL encryption</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-lg-4">
                  <!-- Order Summary -->
                  <div class="payment-summary" style="background: rgba(255, 255, 255, 0.05); padding: 30px; border-radius: 12px; margin-bottom: 30px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 20px;">Order Summary</h4>
                    
                    <div id="selectedPackageSummary">
                      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <span id="packageSummaryName" style="color: var(--text-color);">Plus Soulmate Package</span>
                        <span id="packageSummaryPrice" style="color: var(--accent-color); font-weight: 600;">$29.99</span>
                      </div>
                    </div>

                    <div style="border-top: 1px solid var(--divider-color); padding-top: 15px; margin-top: 20px;">
                      <div style="display: flex; justify-content: space-between; font-size: 1.2rem;">
                        <strong style="color: var(--primary-color);">Total</strong>
                        <strong id="totalPrice" style="color: var(--accent-color);">$29.99</strong>
                      </div>
                    </div>

                    <div style="margin-top: 20px; padding: 15px; background: rgba(169, 62, 23, 0.1); border-radius: 8px; font-size: 14px; color: var(--text-color);">
                      <div style="margin-bottom: 5px;">✨ <strong>Includes:</strong> Everything in Basic + location-based cosmic insights + enhanced astrological analysis using birth data + expanded personalized PDF report with deeper compatibility insights</div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="what-we-btn checkout-nav" style="margin: 40px 0px; display: flex; justify-content: space-between; align-items: center;">
                <button type="button" class="btn-default" id="backToStep5">Back</button>
                <div style="display: flex; gap: 15px;">
                  <button type="button" class="btn-default" id="testDeliverables" style="background: #00d4aa; border-color: #00d4aa;">TEST Deliverables</button>
                  <button type="button" class="btn-default" id="completeOrder">Complete Order - $29.99</button>
                </div>
              </div>
            </div>

            <div
              id="orderComplete"
              class="wow fadeInUp"
              data-wow-delay="0.1s"
              style="display: none"
            >
              <div class="section-title section-title-center">
                <h3>All done</h3>
                <h2 data-cursor="-opaque" style="margin: 40px 0px 0px">
                  You're <span>all set!</span>
                </h2>
              </div>
              <p
                style="
                  display: flex;
                  justify-content: center;
                  margin: 0px 0px 40px;
                "
              >
                🎉 Success! Your personalized soulmate sketch has been generated! 
                Check your email for your custom sketch and reading.
              </p>
              <div class="what-we-btn order-complete-nav">
                <a
                  id="viewSoulSketchImage"
                  href="#"
                  class="btn-default"
                  >View SoulSketch Image</a
                >
                <a id="viewSoulSketchReport" href="#" class="btn-default"
                  >View SoulSketch PDF Report</a
                >
              </div>
              
              <!-- In-App Viewer Modal -->
              <div id="deliverableViewer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; padding: 20px; box-sizing: border-box;">
                <div style="position: relative; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                  <button id="closeViewer" style="position: absolute; top: 20px; right: 30px; background: rgba(255,255,255,0.9); border: none; font-size: 24px; padding: 10px 15px; cursor: pointer; border-radius: 5px; z-index: 10001;">✕</button>
                  <div id="viewerContent" style="max-width: 95%; width: min(1200px, 95vw); max-height: 90%; overflow: auto; background: white; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Order Wizard End -->

    <!-- Footer Start -->
    <footer class="main-footer bg-section">
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <!-- Footer Header Start -->
            <div class="footer-header">
              <!-- Section Title Start -->
              <div class="section-title">
                <h2 data-cursor="-opaque">
                  Start your <span>soulmate sketch</span> today.
                </h2>
              </div>
              <!-- Section Title End -->

              <!-- Our Solutions CIrcle Start -->
              <div class="our-solutions-circle">
                <a href="order.html">
                  <figure>
                    <img src="images/our-solutions-circle.svg" alt="" />
                  </figure>

                  <div class="agency-circle-arrow">
                    <img src="images/arrow-white.svg" alt="" />
                  </div>
                </a>
              </div>
              <!-- Our Solutions CIrcle End -->
            </div>
            <!-- Footer Header End -->
          </div>

          <div class="col-lg-3 col-md-6">
            <!-- About Footer Start -->
            <div class="about-footer">
              <!-- Footer Logo Start -->
              <div class="footer-logo">
                <img
                  src="images/footer-logo.svg"
                  alt="Sketch My Soulmate Footer Logo"
                  style="width: 183px; height: 50px"
                />
              </div>
              <!-- Footer Logo End -->

              <!-- About Footer Content Start -->
              <div class="about-footer-content">
                <p>
                  Personalized soulmate sketches crafted with AI‑assisted
                  artistry — delivered to your inbox within 24 hours.
                </p>
              </div>
              <!-- About Footer Content End -->

              <!-- Footer Social Link Start -->
              <div class="footer-social-links">
                <ul>
                  <li>
                    <a href="index.html#"
                      ><i class="fa-brands fa-facebook-f"></i
                    ></a>
                  </li>
                  <li>
                    <a href="index.html#"
                      ><i class="fa-brands fa-dribbble"></i
                    ></a>
                  </li>
                  <li>
                    <a href="index.html#"
                      ><i class="fa-brands fa-instagram"></i
                    ></a>
                  </li>
                  <li>
                    <a href="index.html#"
                      ><i class="fa-brands fa-linkedin-in"></i
                    ></a>
                  </li>
                </ul>
              </div>
              <!-- Footer Social Link End -->
            </div>
            <!-- About Footer End -->
          </div>

          <div class="col-lg-3 col-md-6">
            <!-- Footer Links Start -->
            <div class="footer-links footer-service-links">
              <h3>Explore</h3>
              <ul>
                <li><a href="how-it-works.html">How It Works</a></li>
                <li><a href="gallery.html">Gallery</a></li>
                <li><a href="pricing.html">Pricing</a></li>
                <li><a href="reviews.html">Reviews</a></li>
              </ul>
            </div>
            <!-- Footer Links End -->
          </div>

          <div class="col-lg-3 col-md-5">
            <!-- Footer Links Start -->
            <div class="footer-links">
              <h3>Contact</h3>

              <!-- Footer Contact Item Start -->
              <div class="footer-contact-item">
                <p>support@soulmatesketch.com</p>
              </div>
              <!-- Footer Contact Item End -->

              <!-- Footer Contact Item Start -->
              <div class="footer-contact-item">
                <p>Need any help?</p>
                <h3><a href="faq.html">Visit FAQ</a></h3>
              </div>
              <!-- Footer Contact Item End -->
            </div>
            <!-- Footer Links End -->
          </div>

          <div class="col-lg-3 col-md-7">
            <!-- Footer Newsletter Start -->
            <div class="footer-links">
              <h3>Subscribe To Newsletter</h3>
              <p>
                Subscribe to our newsletter for the latest updates, exclusive
                content.
              </p>

              <!-- Footer Newsletter Form Start -->
              <div class="footer-newsletter-form">
                <form id="newslettersForm" action="index.html#" method="POST">
                  <div class="form-group">
                    <input
                      type="email"
                      name="mail"
                      class="form-control"
                      id="mail"
                      placeholder="Email Address *"
                      required
                    />
                    <button type="submit" class="btn-default">
                      <img src="images/arrow-white.svg" alt="" />
                    </button>
                  </div>
                </form>
              </div>
              <!-- Footer Newsletter Form End -->
            </div>
            <!-- Footer Newsletter End -->
          </div>

          <div class="col-lg-12">
            <!-- Footer Copyright Text Start -->
            <div class="footer-copyright-text">
              <p>Copyright © 2025 All Rights Reserved.</p>
            </div>
            <!-- Footer Copyright Text End -->
          </div>

          <div class="col-lg-12">
            <div class="footer-disclaimer-text">
              <p>Sketch My Soulmate is for entertainment and inspiration.</p>
            </div>
          </div>

          <div class="col-lg-12">
            <!-- Footer Brand Text Start -->
            <div class="footer-nextmind-text">
              <h2>Sketch My Soulmate.</h2>
            </div>
            <!-- Footer Brand Text End -->
          </div>
        </div>
      </div>
    </footer>
    <!-- Footer End -->

    <!-- Jquery Library File -->
    <script src="js/jquery-3.7.1.min.js"></script>
    <!-- Bootstrap js file -->
    <script src="js/bootstrap.min.js"></script>
    <!-- Validator js file -->
    <script src="js/validator.min.js"></script>
    <!-- SlickNav js file -->
    <script src="js/jquery.slicknav.js"></script>
    <!-- Swiper js file -->
    <script src="js/swiper-bundle.min.js"></script>
    <!-- Counter js file -->
    <script src="js/jquery.waypoints.min.js"></script>
    <script src="js/jquery.counterup.min.js"></script>
    <!-- Magnific js file -->
    <script src="js/jquery.magnific-popup.min.js"></script>
    <!-- Parallax js -->
    <script src="js/parallaxie.js"></script>
    <!-- MagicCursor js file -->
    <script src="js/gsap.min.js"></script>
    <script src="js/magiccursor.js"></script>
    <!-- Text Effect js file -->
    <script src="js/SplitText.js"></script>
    <script src="js/ScrollTrigger.min.js"></script>
    <!-- SmoothScroll -->
    <script src="js/SmoothScroll.js"></script>
    <!-- YTPlayer js File -->
    <script src="js/jquery.mb.YTPlayer.min.js"></script>
    <!-- Wow js file -->
    <script src="js/wow.min.js"></script>
    <!-- Main Custom js file -->
    <script src="js/function.js"></script>
    <script>
      (function () {
        const defaultState = {
          user: {
            firstName: "",
            email: "",
            pronouns: "",
            country: "",
            timezone: "",
            attractedTo: "all-genders",
            ageRange: "",
          },
          birth: {
            date: "",
            time: "",
            city: "",
            zodiac: "",
            includeSpiritualReading: false,
          },
          appearance: {
            faceShape: "no-preference",
            facialHair: "no-preference",
            freckles: "no-preference",
            hairLength: "no-preference",
            hairTexture: "no-preference",
            hairColor: "no-preference",
            eyeColor: "no-preference",
            eyeShape: "no-preference",
            skinTone: "no-preference",
            apparentAge: "no-preference",
            culturalResonance: "",
          },
          personality: {
            introvertExtrovert: 50,
            groundedAdventurous: 50,
            analyticalCreative: 50,
            values: [],
            loveLanguages: {
              words: 20,
              qualityTime: 20,
              gifts: 20,
              acts: 20,
              touch: 20,
            },
          },
          relationship: {
            lookingFor: "serious",
            mustHaves: [],
            dealBreakers: "",
          },
          preferences: {
            artStyle: "pencil-realistic",
            auraPalette: "warm",
            addons: {
              colorUpgrade: false,
              reading: false,
              compatibility: false,
              rush12h: false,
            },
            formats: { jpg: true, pdf: false },
          },
        };

        let state = defaultState;
        let currentStep = 1;

        // Cache DOM
        const stepSections = Array.from(
          document.querySelectorAll(".order-step")
        );
        const progressBar = document.getElementById("progressBar");
        const stepLabel = document.getElementById("stepLabel");

        const orderForm = document.getElementById("orderForm");
        const orderComplete = document.getElementById("orderComplete");
        const mailtoDraft = document.getElementById("mailtoDraft");

        // Init timezone if empty
        try {
          if (!state.user.timezone) {
            state.user.timezone =
              Intl.DateTimeFormat().resolvedOptions().timeZone || "";
          }
        } catch (e) {}

        // Hydrate inputs from state
        syncStateToForm();
        goToStep(currentStep);

        // Input listeners (delegate simple ones)
        orderForm.addEventListener("input", handleInputChange, true);
        orderForm.addEventListener("change", handleInputChange, true);

        // Nav buttons
        orderForm.addEventListener("click", function (e) {
          const t = e.target;
          if (t.classList.contains("next")) {
            e.preventDefault();
            if (!validateCurrentStep()) return;
            goToStep(Math.min(5, currentStep + 1));
          }
          if (t.classList.contains("back")) {
            e.preventDefault();
            goToStep(Math.max(1, currentStep - 1));
          }
          if (t.classList.contains("skip")) {
            e.preventDefault();
            goToStep(Math.min(5, currentStep + 1));
          }
          if (t.classList.contains("package-select")) {
            e.preventDefault();
            // Handle package selection
            const packageCard = t.closest('.package-card');
            const packageType = packageCard.getAttribute('data-package');
            const packageName = packageCard.querySelector('h4').textContent;
            const packagePrice = packageCard.querySelector('.price').textContent;
            
            // Update state
            state.selectedPackage = {
              type: packageType,
              name: packageName,
              price: packagePrice
            };
            
            // Visual feedback
            document.querySelectorAll('.package-card').forEach(card => card.classList.remove('selected'));
            packageCard.classList.add('selected');
            
            // Show selected package info
            const selectedPackageDiv = document.getElementById('selectedPackage');
            document.getElementById('packageName').textContent = packageName;
            document.getElementById('packagePrice').textContent = packagePrice;
            selectedPackageDiv.style.display = 'block';
          }
        });

        // Submit (generate deliverables)
        orderForm.addEventListener("submit", function (e) {
          e.preventDefault();
          if (!validateCurrentStep(true)) return;

          // Build quiz payload from state
          const quiz = {
            user: state.user,
            birth: state.birth,
            appearance: state.appearance,
            personality: state.personality,
            relationship: state.relationship,
            preferences: state.preferences,
            interest: state.user?.attractedTo === 'women' ? 'female' : state.user?.attractedTo === 'men' ? 'male' : 'surprise',
            style: state.preferences?.artStyle || 'pencil-realistic'
          };

          (async function run() {
            try {
              // 1) Create order
              const createRes = await fetch('/api/orders', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  email: state.user.email || 'test@example.com',
                  name: state.user.firstName || 'Test User',
                  gender: state.user.pronouns || 'prefer-not-to-say',
                  preferred_gender: state.user.attractedTo || 'all-genders',
                  age_range: state.user.ageRange || '25-34',
                  hair_color: state.appearance.hairColor || 'no-preference',
                  eye_color: state.appearance.eyeColor || 'no-preference',
                  personality_traits: JSON.stringify({
                    introvertExtrovert: state.personality.introvertExtrovert,
                    groundedAdventurous: state.personality.groundedAdventurous,
                    analyticalCreative: state.personality.analyticalCreative,
                    values: state.personality.values,
                    loveLanguages: state.personality.loveLanguages
                  }),
                  hobbies: JSON.stringify({
                    lookingFor: state.relationship.lookingFor,
                    mustHaves: state.relationship.mustHaves,
                    dealBreakers: state.relationship.dealBreakers
                  }),
                  birth_date: state.birth.date,
                  birth_time: state.birth.time,
                  birth_city: state.birth.city,
                  package: state.selectedPackage?.type || 'premium'
                })
              });
              if (!createRes.ok) throw new Error('Failed to create order');
              const order = await createRes.json();
              
              // Store order ID in localStorage for later access
              localStorage.setItem('currentOrderId', order.id);

              // 2) Submit intake (no photo in this flow)
              const intakeRes = await fetch(`/api/orders/${order.id}/intake`, {
                method: 'POST',
                body: (() => { const f = new FormData(); f.append('quiz', JSON.stringify(quiz)); return f; })()
              });
              if (!intakeRes.ok) throw new Error('Failed to submit intake');

              // 3) Show generating screen and generate deliverables
              showGeneratingScreen();
              
              const genRes = await fetch(`/api/orders/${order.id}/generate`, { method: 'POST' });
              if (!genRes.ok) {
                hideGeneratingScreen();
                throw new Error('Failed to generate');
              }
              const result = await genRes.json();
              
              hideGeneratingScreen();

              // 4) Show results
              // Store the result paths for viewer
              window.currentSketchImage = result.sketch_url || result.imagePath;
              window.currentReportPath = `/api/orders/${order.id}/report`;
              console.log('Generation complete, image URL:', window.currentSketchImage);
              showCheckout();
            } catch (err) {
              hideGeneratingScreen();
              alert('Generation failed. Please try again.');
              console.error(err);
            }
          })();
        });

        // Checkout button event listeners
        document.addEventListener('click', function(e) {
          if (e.target.id === 'backToStep5') {
            // Go back to step 5
            document.getElementById('checkoutSection').style.display = 'none';
            orderForm.style.display = 'block';
            goToStep(5);
          }
          
          if (e.target.id === 'testDeliverables') {
            // TEST button - show completion without payment
            document.getElementById('checkoutSection').style.display = 'none';
            showComplete();
          }
          
          if (e.target.id === 'completeOrder') {
            // Complete Order button - process payment then show completion
            // For now, simulate successful payment
            alert('Payment processed successfully! (Demo mode)');
            document.getElementById('checkoutSection').style.display = 'none';
            showComplete();
          }
        });

        // Credit card formatting
        document.addEventListener('input', function(e) {
          if (e.target.id === 'cardNumber') {
            let value = e.target.value.replace(/\s+/g, '').replace(/[^0-9]/gi, '');
            let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
            if (formattedValue.length > 19) formattedValue = formattedValue.substr(0, 19);
            e.target.value = formattedValue;
          }
          
          if (e.target.id === 'expDate') {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
              value = value.substr(0, 2) + (value.length > 2 ? ' / ' + value.substr(2, 2) : '');
            }
            e.target.value = value;
          }
          
          if (e.target.id === 'securityCode') {
            e.target.value = e.target.value.replace(/\D/g, '');
          }
        });

        function handleInputChange(e) {
          const id = e.target.id;
          const el = e.target;
          // Map inputs to state
          switch (id) {
            // Step 1
            case "firstName":
              state.user.firstName = el.value || "";
              break;
            case "email":
              state.user.email = el.value || "";
              break;
            case "pronouns":
              state.user.pronouns = el.value || "";
              break;
            case "country":
              state.user.country = el.value || "";
              break;
            case "timezone":
              state.user.timezone = el.value || "";
              break;
            case "attractedTo":
              state.user.attractedTo = el.value || "all-genders";
              break;
            case "ageRange":
              state.user.ageRange = el.value || "";
              break;
            // Step 2
            case "birthDate":
              state.birth.date = el.value || "";
              deriveZodiac();
              break;
            case "birthTime":
              state.birth.time = el.value || "";
              break;
            case "birthCity":
              state.birth.city = el.value || "";
              break;
            case "zodiac":
              state.birth.zodiac = el.value || "";
              break;
            case "includeReading":
              state.birth.includeSpiritualReading = !!el.checked;
              break;
            // Step 3
            case "faceShape":
              state.appearance.faceShape = el.value;
              break;
            case "facialHair":
              state.appearance.facialHair = el.value;
              break;
            case "freckles":
              state.appearance.freckles = el.value;
              break;
            case "hairLength":
              state.appearance.hairLength = el.value;
              break;
            case "hairTexture":
              state.appearance.hairTexture = el.value;
              break;
            case "hairColor":
              state.appearance.hairColor = el.value;
              break;
            case "eyeColor":
              state.appearance.eyeColor = el.value;
              break;
            case "eyeShape":
              state.appearance.eyeShape = el.value;
              break;
            case "skinTone":
              state.appearance.skinTone = el.value;
              break;
            case "apparentAge":
              state.appearance.apparentAge = el.value;
              break;
            case "culturalResonance":
              state.appearance.culturalResonance = el.value || "";
              break;
            // Step 4
            case "slider_introvert":
              state.personality.introvertExtrovert = parseInt(
                el.value || "50",
                10
              );
              break;
            case "slider_grounded":
              state.personality.groundedAdventurous = parseInt(
                el.value || "50",
                10
              );
              break;
            case "slider_analytical":
              state.personality.analyticalCreative = parseInt(
                el.value || "50",
                10
              );
              break;
            case "ll_words":
              state.personality.loveLanguages.words = parseInt(
                el.value || "20",
                10
              );
              break;
            case "ll_qualityTime":
              state.personality.loveLanguages.qualityTime = parseInt(
                el.value || "20",
                10
              );
              break;
            case "ll_gifts":
              state.personality.loveLanguages.gifts = parseInt(
                el.value || "20",
                10
              );
              break;
            case "ll_acts":
              state.personality.loveLanguages.acts = parseInt(
                el.value || "20",
                10
              );
              break;
            case "ll_touch":
              state.personality.loveLanguages.touch = parseInt(
                el.value || "20",
                10
              );
              break;
            // Step 5 handled by checkbox listeners below
            case "lookingFor":
              state.relationship.lookingFor = el.value;
              break;
            case "dealBreakers":
              state.relationship.dealBreakers = el.value || "";
              break;
            // Step 6
            case "artStyle":
              state.preferences.artStyle = el.value;
              break;
            case "auraPalette":
              state.preferences.auraPalette = el.value;
              break;
            case "addon_color":
              state.preferences.addons.colorUpgrade = !!el.checked;
              break;
            case "addon_reading":
              state.preferences.addons.reading = !!el.checked;
              break;
            case "addon_compat":
              state.preferences.addons.compatibility = !!el.checked;
              break;
            case "addon_rush":
              state.preferences.addons.rush12h = !!el.checked;
              break;
            case "fmt_jpg":
              state.preferences.formats.jpg = !!el.checked;
              break;
            case "fmt_pdf":
              state.preferences.formats.pdf = !!el.checked;
              break;
          }

          // Step 4 values multi-select (checkboxes)
          if (id && id.startsWith("val_")) {
            const value = el.value;
            const list = new Set(state.personality.values);
            if (el.checked) list.add(value);
            else list.delete(value);
            state.personality.values = Array.from(list);
          }

          // Step 5 must-haves
          if (
            [
              "mh_kids",
              "mh_pet",
              "mh_smoke",
              "mh_active",
              "mh_spirit",
              "mh_career",
              "mh_family",
            ].includes(id)
          ) {
            const mhMap = {
              mh_kids: "non-empty:wants-kids",
              mh_pet: "non-empty:pet-friendly",
              mh_smoke: "non-empty:non-smoker",
              mh_active: "non-empty:active-lifestyle",
              mh_spirit: "non-empty:spiritual-openness",
              mh_career: "non-empty:career-driven",
              mh_family: "non-empty:family-oriented",
            };
            const value = mhMap[id].split(":")[1];
            const set = new Set(state.relationship.mustHaves);
            if (el.checked) set.add(value);
            else set.delete(value);
            state.relationship.mustHaves = Array.from(set);
          }

          if (id === "birthDate") syncStateToForm(["zodiac"]);
        }

        function deriveZodiac() {
          if (!state.birth.date) {
            state.birth.zodiac = "";
            return;
          }
          try {
            const d = new Date(state.birth.date + "T12:00:00");
            const m = d.getUTCMonth() + 1;
            const day = d.getUTCDate();
            // Simple western zodiac ranges (approximate)
            const z =
              (m == 3 && day >= 21) || (m == 4 && day <= 19)
                ? "Aries"
                : (m == 4 && day >= 20) || (m == 5 && day <= 20)
                ? "Taurus"
                : (m == 5 && day >= 21) || (m == 6 && day <= 20)
                ? "Gemini"
                : (m == 6 && day >= 21) || (m == 7 && day <= 22)
                ? "Cancer"
                : (m == 7 && day >= 23) || (m == 8 && day <= 22)
                ? "Leo"
                : (m == 8 && day >= 23) || (m == 9 && day <= 22)
                ? "Virgo"
                : (m == 9 && day >= 23) || (m == 10 && day <= 22)
                ? "Libra"
                : (m == 10 && day >= 23) || (m == 11 && day <= 21)
                ? "Scorpio"
                : (m == 11 && day >= 22) || (m == 12 && day <= 21)
                ? "Sagittarius"
                : (m == 12 && day >= 22) || (m == 1 && day <= 19)
                ? "Capricorn"
                : (m == 1 && day >= 20) || (m == 2 && day <= 18)
                ? "Aquarius"
                : "Pisces";
            state.birth.zodiac = z;
          } catch (e) {
            state.birth.zodiac = "";
          }
        }

        function goToStep(n) {
          currentStep = n;

          stepSections.forEach((s, i) => {
            s.style.display = i + 1 === n ? "block" : "none";
          });
          const pct = Math.round((n / 5) * 100);
          progressBar.style.width = pct + "%";
          progressBar.parentElement.setAttribute("aria-valuenow", String(n));
          stepLabel.textContent = `Step ${n} of 5 — ${getStepLabel(n)}`;
        }

        function getStepLabel(n) {
          return (
            [
              "About you",
              "Birth & spiritual insights",
              "Personality & lifestyle",
              "Relationship goals",
              "Choose your package",
            ][n - 1] || ""
          );
        }

        function validateCurrentStep(isSubmit) {
          if (currentStep === 1) {
            const email = (state.user.email || "").trim();
            const ok = /.+@.+\..+/.test(email);
            if (!ok) {
              alert("Please enter a valid email.");
              return false;
            }
          }
          if (currentStep === 5) {
            if (!state.selectedPackage) {
              alert("Please select a package to continue.");
              return false;
            }
          }

          return true;
        }

        function syncStateToForm(only) {
          const ids = new Set(only || []);
          function setVal(id, val) {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.type === "checkbox") el.checked = !!val;
            else el.value = val == null ? "" : String(val);
          }
          setVal("firstName", state.user.firstName);
          setVal("email", state.user.email);
          setVal("pronouns", state.user.pronouns);
          setVal("country", state.user.country);
          setVal("timezone", state.user.timezone);
          setVal("attractedTo", state.user.attractedTo);
          setVal("ageRange", state.user.ageRange);
          setVal("birthDate", state.birth.date);
          setVal("birthTime", state.birth.time);
          setVal("birthCity", state.birth.city);
          setVal("zodiac", state.birth.zodiac);
          setVal("includeReading", state.birth.includeSpiritualReading);
          setVal("faceShape", state.appearance.faceShape);
          setVal("facialHair", state.appearance.facialHair);
          setVal("freckles", state.appearance.freckles);
          setVal("hairLength", state.appearance.hairLength);
          setVal("hairTexture", state.appearance.hairTexture);
          setVal("hairColor", state.appearance.hairColor);
          setVal("eyeColor", state.appearance.eyeColor);
          setVal("eyeShape", state.appearance.eyeShape);
          setVal("skinTone", state.appearance.skinTone);
          setVal("apparentAge", state.appearance.apparentAge);
          setVal("culturalResonance", state.appearance.culturalResonance);
          setVal("slider_introvert", state.personality.introvertExtrovert);
          setVal("slider_grounded", state.personality.groundedAdventurous);
          setVal("slider_analytical", state.personality.analyticalCreative);
          setVal("ll_words", state.personality.loveLanguages.words);
          setVal("ll_qualityTime", state.personality.loveLanguages.qualityTime);
          setVal("ll_gifts", state.personality.loveLanguages.gifts);
          setVal("ll_acts", state.personality.loveLanguages.acts);
          setVal("ll_touch", state.personality.loveLanguages.touch);
          // values checkboxes
          [
            "family",
            "growth",
            "stability",
            "kindness",
            "spirituality",
            "ambition",
            "humor",
            "health",
            "curiosity",
            "service",
          ].forEach((v) => {
            const el = document.getElementById("val_" + v);
            if (el) el.checked = (state.personality.values || []).includes(v);
          });
          // must‑haves
          const mh = new Set(state.relationship.mustHaves || []);
          const map = {
            mh_kids: "wants-kids",
            mh_pet: "pet-friendly",
            mh_smoke: "non-smoker",
            mh_active: "active-lifestyle",
            mh_spirit: "spiritual-openness",
            mh_career: "career-driven",
            mh_family: "family-oriented",
          };
          Object.keys(map).forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.checked = mh.has(map[id]);
          });
          // step 6 formats/addons
          setVal("artStyle", state.preferences.artStyle);
          setVal("auraPalette", state.preferences.auraPalette);
          
          // Safely set addon checkboxes with null checks
          const addonColor = document.getElementById("addon_color");
          if (addonColor) addonColor.checked = !!state.preferences.addons.colorUpgrade;
          
          const addonReading = document.getElementById("addon_reading");
          if (addonReading) addonReading.checked = !!state.preferences.addons.reading;
          
          const addonCompat = document.getElementById("addon_compat");
          if (addonCompat) addonCompat.checked = !!state.preferences.addons.compatibility;
          
          const addonRush = document.getElementById("addon_rush");
          if (addonRush) addonRush.checked = !!state.preferences.addons.rush12h;
          
          const fmtJpg = document.getElementById("fmt_jpg");
          if (fmtJpg) fmtJpg.checked = !!state.preferences.formats.jpg;
          
          const fmtPdf = document.getElementById("fmt_pdf");
          if (fmtPdf) fmtPdf.checked = !!state.preferences.formats.pdf;
        }

        function showCheckout() {
          // Update order summary with selected package
          if (state.selectedPackage) {
            const packageSummaryName = document.getElementById('packageSummaryName');
            const packageSummaryPrice = document.getElementById('packageSummaryPrice');
            const totalPrice = document.getElementById('totalPrice');
            const completeOrderBtn = document.getElementById('completeOrder');
            
            if (packageSummaryName) packageSummaryName.textContent = state.selectedPackage.name;
            if (packageSummaryPrice) packageSummaryPrice.textContent = state.selectedPackage.price;
            if (totalPrice) totalPrice.textContent = state.selectedPackage.price;
            if (completeOrderBtn) completeOrderBtn.textContent = `Complete Order - ${state.selectedPackage.price}`;
          }
          
          // Initialize Apple Pay if available
          initializeApplePay();
          
          // Hide form and show checkout
          orderForm.style.display = "none";
          document.getElementById('checkoutSection').style.display = "block";
        }

        // Apple Pay functionality
        function initializeApplePay() {
          if (window.ApplePaySession && ApplePaySession.canMakePayments()) {
            const applePayButton = document.getElementById('applePayButton');
            if (applePayButton) {
              applePayButton.style.display = 'flex';
              applePayButton.addEventListener('click', startApplePaySession);
            }
          }
        }

        function startApplePaySession() {
          if (!state.selectedPackage) return;
          
          const request = {
            countryCode: 'US',
            currencyCode: 'USD',
            supportedNetworks: ['visa', 'masterCard', 'amex'],
            merchantCapabilities: ['supports3DS'],
            total: {
              label: state.selectedPackage.name,
              amount: state.selectedPackage.price.replace('$', '')
            }
          };

          const session = new ApplePaySession(3, request);
          
          session.onvalidatemerchant = (event) => {
            // In production, you would validate with your payment processor
            console.log('Apple Pay merchant validation:', event);
            // For demo purposes, we'll just show a completion message
            setTimeout(() => {
              session.completePayment(ApplePaySession.STATUS_SUCCESS);
              showComplete();
            }, 1000);
          };

          session.onpaymentauthorized = (event) => {
            console.log('Apple Pay authorized:', event.payment);
            // Process the payment with your payment processor
            session.completePayment(ApplePaySession.STATUS_SUCCESS);
            showComplete();
          };

          session.oncancel = () => {
            console.log('Apple Pay cancelled');
          };

          session.begin();
        }

        // Generating Screen Functions
        function showGeneratingScreen() {
          const screen = document.getElementById('generatingReportScreen');
          const statusElement = document.getElementById('generatingStatus');
          const messages = [
            'Connecting with the cosmic forces...',
            'Analyzing your spiritual energy...',
            'Channeling your soulmate\'s essence...',
            'Drawing from the universe\'s wisdom...',
            'Manifesting your perfect match...',
            'Finalizing your cosmic connection...'
          ];
          
          let messageIndex = 0;
          screen.style.display = 'flex';
          
          // Animate screen entrance
          setTimeout(() => {
            screen.style.opacity = '1';
          }, 10);
          
          // Cycle through mystical messages
          window.generatingInterval = setInterval(() => {
            messageIndex = (messageIndex + 1) % messages.length;
            statusElement.textContent = messages[messageIndex];
          }, 3000);
        }

        function hideGeneratingScreen() {
          const screen = document.getElementById('generatingReportScreen');
          
          // Clear the message interval
          if (window.generatingInterval) {
            clearInterval(window.generatingInterval);
            window.generatingInterval = null;
          }
          
          // Fade out animation
          screen.style.opacity = '0';
          screen.style.transition = 'opacity 0.5s ease-out';
          
          setTimeout(() => {
            screen.style.display = 'none';
            screen.style.transition = '';
          }, 500);
        }

        function showComplete() {
          // Build mailto link
          try {
            const subject = encodeURIComponent(
              "Sketch My Soulmate — Order Completed"
            );
            const body = encodeURIComponent(
              "Draft data (JSON):\n\n" + JSON.stringify(state, null, 2)
            );
            mailtoDraft.href =
              "mailto:support@soulmatesketch.com?subject=" +
              subject +
              "&body=" +
              body;
          } catch (e) {}
          orderForm.style.display = "none";
          orderComplete.style.display = "block";
        }

        function escapeHtml(s) {
          return String(s).replace(
            /[&<>"']/g,
            (c) =>
              ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#039;",
              }[c])
          );
        }

        // Check if there's a completed order and set up deliverable paths
        async function checkForCompletedOrder() {
          // Check if completion section exists (may be hidden initially)
          const completionSection = document.querySelector('.order-complete-nav');
          
          // Continue regardless of visibility - we'll show it if needed

          // Only check URL parameters - ignore localStorage to prevent stale data issues
          const urlParams = new URLSearchParams(window.location.search);
          let orderId = urlParams.get('orderId');
          
          // Clear any stale localStorage data immediately
          localStorage.removeItem('currentOrderId');
          
          // Only proceed if we have a valid orderId (not null, undefined, empty string, or 'null' string)
          if (orderId && orderId !== 'null' && orderId.trim() !== '') {
            try {
              const response = await fetch(`/api/orders/${orderId}`);
              if (response.ok) {
                const order = await response.json();
                if (order.status === 'completed' && order.generation_completed) {
                  // Set up the deliverable paths for the viewer
                  if (order.image_path) {
                    // Convert image file path to API URL format
                    const imageFilename = order.image_path.split('/').pop(); // Get just the filename
                    window.currentSketchImage = `/api/images/${imageFilename}`;
                  }
                  window.currentReportPath = `/api/orders/${orderId}/report`;
                  
                  // Show the completion section only for actually completed orders
                  if (completionSection) {
                    const parentSection = completionSection.closest('section');
                    if (parentSection && parentSection.style.display === 'none') {
                      parentSection.style.display = 'block';
                    }
                  }
                }
              } else if (response.status === 404) {
                // Order not found - clean up invalid localStorage data
                localStorage.removeItem('currentOrderId');
              }
            } catch (error) {
              // Silently handle errors - no debug output
            }
          }
        }

        // SoulSketch deliverable viewer functionality
        function initDeliverableViewer() {
          const viewer = document.getElementById('deliverableViewer');
          const viewerContent = document.getElementById('viewerContent');
          const closeBtn = document.getElementById('closeViewer');
          const imageBtn = document.getElementById('viewSoulSketchImage');
          const reportBtn = document.getElementById('viewSoulSketchReport');

          // Close viewer
          closeBtn.addEventListener('click', function() {
            viewer.style.display = 'none';
            viewerContent.innerHTML = '';
          });

          // Close on background click
          viewer.addEventListener('click', function(e) {
            if (e.target === viewer) {
              viewer.style.display = 'none';
              viewerContent.innerHTML = '';
            }
          });

          // View SoulSketch Image
          imageBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.currentSketchImage) {
              viewerContent.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                  <h2 style="color: #667eea; margin-bottom: 20px;">Your SoulSketch Image</h2>
                  <img src="${window.currentSketchImage}" style="max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" alt="Your Soulmate Sketch">
                  <div style="margin-top: 20px;">
                    <a href="${window.currentSketchImage}" download="my-soulmate-sketch.png" style="background: #667eea; color: white; padding: 12px 24px; border-radius: 5px; text-decoration: none; display: inline-block;">Download Image</a>
                  </div>
                </div>
              `;
              viewer.style.display = 'block';
            } else {
              alert('Image not yet available. Please complete the generation process first.');
            }
          });

          // View SoulSketch Report
          reportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.currentReportPath) {
              viewerContent.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                  <h2 style="color: #667eea; margin-bottom: 20px;">Your SoulSketch PDF Report</h2>
                  <iframe src="${window.currentReportPath}" style="width: 100%; height: 75vh; border: none; border-radius: 10px;" frameborder="0"></iframe>
                  <div style="margin-top: 20px;">
                    <a href="${window.currentReportPath}" download="my-soulmate-report.pdf" style="background: #667eea; color: white; padding: 12px 24px; border-radius: 5px; text-decoration: none; display: inline-block;">Download PDF</a>
                  </div>
                </div>
              `;
              viewer.style.display = 'block';
            } else {
              alert('Report not yet available. Please complete the generation process first.');
            }
          });
        }

        // Placeholder for future image loading functionality
        window.setImagePaths = function(imagePath, reportPath) {
          window.currentSketchImage = imagePath;
          window.currentReportPath = reportPath;
        };
        
        // Initialize viewer when page loads
        document.addEventListener('DOMContentLoaded', function() {
          initDeliverableViewer();
          
          // Only check for completed orders, don't auto-show completion section
          checkForCompletedOrder().then(() => {
            // Completion section will only show if there's actually a completed order
          }).catch(error => {
            // Silently handle errors - don't show debug content
          });
        });

        // STRIPE PAYMENT PROCESSING
        let stripe = null;
        let elements = null;
        let paymentElement = null;
        let expressCheckoutElement = null;
        let clientSecret = null;
        let currentPaymentAmount = 0;
        let currentPackageType = '';
        
        // Initialize Stripe when page loads
        async function initializeStripe() {
          try {
            // Get Stripe publishable key from server
            const configResponse = await fetch('/api/stripe-config');
            const config = await configResponse.json();
            
            if (!config.isConfigured) {
              console.log('Stripe not configured - using fallback payment form');
              document.getElementById('stripe-payment-element').style.display = 'none';
              document.getElementById('fallback-payment-form').style.display = 'block';
              return;
            }
            
            // Initialize Stripe with publishable key
            stripe = Stripe(config.publishableKey);
            
            // Show Stripe elements, hide fallback
            document.getElementById('stripe-payment-element').style.display = 'block';
            document.getElementById('fallback-payment-form').style.display = 'none';
            
            // If we're on the checkout page, automatically setup payment for selected package
            if (document.querySelector('#stripe-payment-element')) {
              const selectedPackage = window.selectedPackage || 'basic';
              const packagePrices = { basic: 1999, plus: 2999, premium: 4999 };
              const amount = packagePrices[selectedPackage];
              
              if (amount) {
                setupStripePayment(amount, selectedPackage);
              }
            }
            
          } catch (error) {
            console.error('Error initializing Stripe:', error);
            // Fall back to demo form
            document.getElementById('stripe-payment-element').style.display = 'none';
            document.getElementById('fallback-payment-form').style.display = 'block';
          }
        }
        
        // Create payment intent and setup Stripe Elements
        async function setupStripePayment(amount, packageType) {
          if (!stripe) {
            console.log('Stripe not initialized - using demo mode');
            return;
          }
          
          // Store current payment details
          currentPaymentAmount = amount;
          currentPackageType = packageType;
          
          try {
            // Create payment intent
            const response = await fetch('/api/payment-intent', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                amount: amount,
                currency: 'usd',
                metadata: {
                  package: packageType,
                  order_id: window.currentFormData?.id || 'unknown'
                }
              }),
            });
            
            const { client_secret } = await response.json();
            clientSecret = client_secret;
            
            // Create Elements instance
            elements = stripe.elements({
              clientSecret: client_secret,
              appearance: {
                theme: 'night',
                variables: {
                  colorPrimary: '#00d4aa',
                  colorBackground: '#1a1a1a',
                  colorText: '#ffffff',
                  borderRadius: '8px'
                }
              }
            });
            
            // Setup Express Checkout (Apple Pay, Google Pay, etc.)
            await setupExpressCheckout(amount);
            
            // Create and mount Payment Element
            paymentElement = elements.create('payment');
            paymentElement.mount('#stripe-payment-element');
            
          } catch (error) {
            console.error('Error setting up Stripe payment:', error);
            // Fall back to demo form
            document.getElementById('stripe-payment-element').style.display = 'none';
            document.getElementById('fallback-payment-form').style.display = 'block';
          }
        }
        
        // Setup Apple Pay and other express checkout methods
        async function setupExpressCheckout(amount) {
          try {
            // Create Express Checkout Element (includes Apple Pay, Google Pay, etc.)
            expressCheckoutElement = elements.create('expressCheckout', {
              buttonType: {
                applePay: 'buy',
                googlePay: 'buy',
              },
              buttonTheme: {
                applePay: 'black',
                googlePay: 'black',
              },
              buttonHeight: 48,
              paymentMethods: {
                applePay: 'always',
                googlePay: 'always',
                link: 'always',
              }
            });
            
            // Check if express checkout methods are available
            const canMakePayment = await expressCheckoutElement.canMakePayment();
            
            if (canMakePayment) {
              // Mount express checkout element
              expressCheckoutElement.mount('#express-checkout-element');
              
              // Show separator between express checkout and card form
              document.getElementById('payment-separator').style.display = 'block';
              
              // Handle express checkout events
              expressCheckoutElement.on('click', (event) => {
                console.log('Express checkout clicked:', event.expressPaymentType);
              });
              
              // Handle successful express checkout
              expressCheckoutElement.on('confirm', async (event) => {
                console.log('Express checkout confirm:', event.expressPaymentType);
                
                try {
                  // Confirm payment with shipping/billing info if needed
                  const {error, paymentIntent} = await stripe.confirmPayment({
                    elements,
                    confirmParams: {
                      return_url: window.location.origin + window.location.pathname,
                    },
                    redirect: 'if_required'
                  });
                  
                  if (error) {
                    console.error('Express checkout payment failed:', error);
                    event.complete('fail');
                  } else if (paymentIntent.status === 'succeeded') {
                    console.log('Express checkout payment succeeded:', paymentIntent.id);
                    event.complete('success');
                    
                    // Hide checkout and show completion
                    document.getElementById('checkoutSection').style.display = 'none';
                    showComplete();
                  }
                } catch (error) {
                  console.error('Express checkout error:', error);
                  event.complete('fail');
                }
              });
              
              console.log('✅ Express checkout (Apple Pay/Google Pay) enabled');
            } else {
              // Hide express checkout container if no methods available
              document.getElementById('express-checkout-element').style.display = 'none';
              document.getElementById('payment-separator').style.display = 'none';
              console.log('ℹ️ Express checkout not available on this device/browser');
            }
            
          } catch (error) {
            console.error('Error setting up express checkout:', error);
            // Hide express checkout elements on error
            document.getElementById('express-checkout-element').style.display = 'none';
            document.getElementById('payment-separator').style.display = 'none';
          }
        }
        
        // Process Stripe payment
        async function processStripePayment() {
          if (!stripe || !elements) {
            // Demo mode - simulate success
            alert('Payment processed successfully! (Demo mode)');
            return true;
          }
          
          try {
            // Confirm payment with Stripe
            const {error, paymentIntent} = await stripe.confirmPayment({
              elements,
              confirmParams: {
                return_url: window.location.origin + window.location.pathname,
              },
              redirect: 'if_required'
            });
            
            if (error) {
              console.error('Payment failed:', error);
              alert('Payment failed: ' + error.message);
              return false;
            }
            
            if (paymentIntent.status === 'succeeded') {
              console.log('Payment succeeded:', paymentIntent.id);
              return true;
            }
            
            console.log('Payment status:', paymentIntent.status);
            return paymentIntent.status === 'succeeded';
            
          } catch (error) {
            console.error('Error processing payment:', error);
            alert('Payment processing error. Please try again.');
            return false;
          }
        }
        
        // Update the complete order button handler
        const originalCompleteOrderHandler = document.getElementById('completeOrder');
        if (originalCompleteOrderHandler) {
          // Remove existing event listener and add new one
          originalCompleteOrderHandler.removeEventListener('click', function() {});
          originalCompleteOrderHandler.addEventListener('click', async function() {
            this.disabled = true;
            this.textContent = 'Processing...';
            
            try {
              const paymentSuccess = await processStripePayment();
              if (paymentSuccess) {
                document.getElementById('checkoutSection').style.display = 'none';
                showComplete();
              } else {
                this.disabled = false;
                this.textContent = 'Complete Order - $' + (window.selectedPackagePrice || '29.99');
              }
            } catch (error) {
              console.error('Order completion error:', error);
              this.disabled = false;
              this.textContent = 'Complete Order - $' + (window.selectedPackagePrice || '29.99');
            }
          });
        }
        
        // Initialize Stripe when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
          initializeStripe();
        });
        
        // Setup payment when proceeding to checkout (modify existing function)
        window.originalProceedToCheckout = window.proceedToCheckout;
        window.proceedToCheckout = function() {
          // Call original checkout logic
          if (window.originalProceedToCheckout) {
            window.originalProceedToCheckout();
          }
          
          // Setup Stripe payment for selected package
          const selectedPackage = window.selectedPackage || 'plus';
          const packagePrices = { basic: 1999, plus: 2999, premium: 4999 };
          const amount = packagePrices[selectedPackage];
          
          if (amount) {
            setupStripePayment(amount, selectedPackage);
          }
        };
      })();
    </script>
  </body>
</html>
